<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>

        <!-- REPORT ACTION FOR BILL -->
        <record id="action_test_result_report_bill" model="ir.actions.report">
            <field name="name">Lab Bill</field>
            <field name="model">test.result</field>
            <field name="report_type">qweb-pdf</field>
            <field name="report_name">rawdah_laboratory_management.test_result_template_bill</field>
            <field name="report_file">rawdah_laboratory_management.test_result_template_bill</field>
            <field name="print_report_name">'Bill - %s' % (object.result_no)</field>
        </record>

        <!-- QWEB TEMPLATE FOR BILL -->
        <template id="test_result_template_bill">
            <t t-call="web.html_container">
                <t t-foreach="docs" t-as="o">
                    <t t-call="web.external_layout">
                        <div class="page">
                            <style>
                                .bill-header { font-size: 16px; font-weight: bold; }
                                .bill-table { font-size: 13px; }
                                .bill-footer { font-size: 12px; }
                            </style>

                            <!-- Header -->
                            <h2 class="text-center bill-header">LABORATORY BILL</h2>
                            <hr/>

                            <!-- Patient Information -->
                            <table class="table table-sm" style="width:100%; border:none; margin-bottom:15px; font-size:13px;">
                                <tbody>
                                    <tr>
                                        <td style="width:50%; vertical-align:top;">
                                            <table style="width:100%; border:none;">
                                                <tr>
                                                    <td style="width:30%;"><strong>Lab. No</strong></td>
                                                    <td style="width:5%;">:</td>
                                                    <td><span t-esc="o.result_no"/></td>
                                                </tr>
                                                <tr>
                                                    <td style="width:30%;"><strong>Patient Name</strong></td>
                                                    <td style="width:5%;">:</td>
                                                    <td>
                                                        <span t-esc="o.patient_id.name" t-if="o.patient_id"/>
                                                        <span t-if="not o.patient_id">N/A</span>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td style="width:30%;"><strong>Age/Gender</strong></td>
                                                    <td style="width:5%;">:</td>
                                                    <td>
                                                        <span t-esc="o.age" t-if="o.age"/>
                                                        <span t-if="not o.age">--</span>
                                                        /
                                                        <span t-esc="o.gender" t-if="o.gender"/>
                                                        <span t-if="not o.gender">--</span>
                                                    </td>
                                                </tr>
                                            </table>
                                        </td>
                                        <td style="width:50%; vertical-align:top;">
                                            <table style="width:100%; border:none;">
                                                <tr>
                                                    <td style="width:30%;"><strong>Bill Date</strong></td>
                                                    <td style="width:5%;">:</td>
                                                    <td>
                                                        <span t-esc="o.result_date" t-if="o.result_date"/>
                                                        <span t-if="not o.result_date">N/A</span>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td style="width:30%;"><strong>Status</strong></td>
                                                    <td style="width:5%;">:</td>
                                                    <td><span t-esc="dict(o._fields['state'].selection).get(o.state)"/></td>
                                                </tr>
                                                <tr>
                                                    <td style="width:30%;"><strong>Phone</strong></td>
                                                    <td style="width:5%;">:</td>
                                                    <td>
                                                        <span t-esc="o.phone" t-if="o.phone"/>
                                                        <span t-if="not o.phone">-</span>
                                                    </td>
                                                </tr>
                                            </table>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>

                            <hr/>

                            <!-- Tests List with Prices -->
                            <h4 style="margin-top:20px; margin-bottom:10px;">Tests Ordered:</h4>
                            <table class="table table-bordered bill-table" style="width:100%;">
                                <thead>
                                    <tr style="background-color:#f0f0f0;">
                                        <th style="width:60%;">Test Name</th>
                                        <th style="width:20%; text-align:right;">Price</th>
                                        <th style="width:20%; text-align:right;">Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr t-foreach="o.test_ids" t-as="test">
                                        <td>
                                            <span t-esc="test.name"/>
                                        </td>
                                        <td class="text-right">
                                            <span t-esc="'{:,.2f}'.format(test.test_amount)" t-if="test.test_amount"/>
                                            <span t-if="not test.test_amount">0.00</span>
                                        </td>
                                        <td class="text-right">
                                            <span t-esc="'{:,.2f}'.format(test.test_amount)" t-if="test.test_amount"/>
                                            <span t-if="not test.test_amount">0.00</span>
                                        </td>
                                    </tr>
                                    <tr t-if="not o.test_ids">
                                        <td colspan="3" class="text-center" style="padding:15px;">
                                            <strong>No tests ordered</strong>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>

                            <br/>

                            <!-- Summary -->
                            <table style="width:100%; border:none; margin-top:20px;">
                                <tr>
                                    <td style="width:60%;"></td>
                                    <td style="width:40%;">
                                        <table style="width:100%; border:1px solid #ddd;">
                                            <tr>
                                                <td style="width:60%; padding:8px;"><strong>Subtotal</strong></td>
                                                <td style="width:40%; text-align:right; padding:8px;" t-esc="'{:,.2f}'.format(sum(o.test_ids.mapped('test_amount')))"/>
                                            </tr>
                                            <tr>
                                                <td style="width:60%; padding:8px;"><strong>Tax (0%)</strong></td>
                                                <td style="width:40%; text-align:right; padding:8px;">0.00</td>
                                            </tr>
                                            <tr style="background-color:#f0f0f0;">
                                                <td style="width:60%; padding:8px;"><strong>Total Amount</strong></td>
                                                <td style="width:40%; text-align:right; padding:8px;"><strong t-esc="'{:,.2f}'.format(sum(o.test_ids.mapped('test_amount')))"/></td>
                                            </tr>
                                        </table>
                                    </td>
                                </tr>
                            </table>

                            <br/>
                            <br/>

                            <!-- Notes -->
                            <div style="margin-top:30px; padding:10px; background-color:#f9f9f9; border:1px solid #ddd;">
                                <p style="margin:0; font-size:11px;">
                                    <strong>Notes:</strong> Payment should be made at the time of receiving the results.
                                </p>
                            </div>

                            <br/>
                            <br/>

                            <!-- Signature Section -->
                            <table style="width:100%; border:none; margin-top:40px;">
                                <tr>
                                    <td style="width:50%; text-align:center; vertical-align:top;">
                                        <p style="margin-bottom:50px;"><strong>Prepared By</strong></p>
                                        <p style="border-top:1px solid black; padding-top:5px;">_____________________</p>
                                        <p style="font-size:11px;">Name &amp; Date</p>
                                    </td>
                                    <td style="width:50%; text-align:center; vertical-align:top;">
                                        <p style="margin-bottom:50px;"><strong>Authorized By</strong></p>
                                        <p style="border-top:1px solid black; padding-top:5px;">_____________________</p>
                                        <p style="font-size:11px;">Name &amp; Date</p>
                                    </td>
                                </tr>
                            </table>

                            <br/>
                            <p class="bill-footer" style="text-align:center; margin-top:30px;">
                                <i>This is a system generated bill.</i>
                            </p>
                        </div>
                    </t>
                </t>
            </t>
        </template>

    </data>
</odoo>